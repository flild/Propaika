@page
@model Propaika_main_app.Pages.Admin.ServiceCases.IndexModel
@{
    ViewData["Title"] = "Управление кейсами";
}
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="neon-header">Кейсы ремонтов</h1>
        <button class="btn btn-neon px-4" onclick="openModal()">+ Добавить кейс</button>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success bg-dark text-success border-success">@TempData["Success"]</div>
    }

    <div class="neon-card p-3">
        <div class="table-responsive">
            <table class="table table-dark-custom align-middle mb-0">
                <thead>
                    <tr>
                        <th style="width: 100px;">Фото</th>
                        <th>Кейс</th>
                        <th>Инфо</th>
                        <th>SEO</th>
                        <th class="text-end">Действия</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.Cases)
                    {
                        // Сериализуем объект для передачи в JS
                        var jsonData = System.Text.Json.JsonSerializer.Serialize(new
                        {
                            id = item.Id,
                            title = item.Title,
                            description = item.Description,
                            deviceModel = item.DeviceModel,
                            serviceType = item.ServiceType,
                            cost = item.Cost,
                            dateCompleted = item.DateCompleted.ToString("yyyy-MM-ddTHH:mm"),
                            slug = item.Slug,
                            metaTitle = item.MetaTitle,
                            metaDescription = item.MetaDescription,
                            imgBefore = item.BeforeImage,
                            imgAfter = item.AfterImage
                        });

                        <tr>
                            <td>
                                <div class="d-flex flex-column gap-1">
                                    @if (!string.IsNullOrEmpty(item.BeforeImage))
                                    {
                                        <img src="@item.BeforeImage" class="rounded" style="width: 50px; height: 50px; object-fit: cover;" alt="До" />
                                    }
                                    @if (!string.IsNullOrEmpty(item.AfterImage))
                                    {
                                        <img src="@item.AfterImage" class="rounded" style="width: 50px; height: 50px; object-fit: cover;" alt="После" />
                                    }
                                </div>
                            </td>
                            <td>
                                <div class="fw-bold text-white">@item.Title</div>
                                <div class="small text-muted">@item.DeviceModel</div>
                            </td>
                            <td>
                                <div class="badge bg-secondary">@item.ServiceType</div>
                                <div class="mt-1 text-success">@item.Cost.ToString("N0") ₽</div>
                            </td>
                            <td>
                                <div class="small text-muted" style="max-width: 150px; overflow:hidden; text-overflow:ellipsis;">
                                    /@item.Slug
                                </div>
                            </td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-light me-2"
                                        onclick='openModal(@jsonData)'>
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <form method="post" asp-page-handler="Delete" asp-route-id="@item.Id"
                                      class="d-inline" onsubmit="return confirm('Удалить кейс навсегда?');">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Модальное окно (Create / Edit) -->
<div class="modal fade" id="caseModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content bg-dark text-white border-secondary">
            <form method="post" asp-page-handler="Save" enctype="multipart/form-data">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="modalTitle">Новый кейс</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" asp-for="Input.Id" id="inputId" />
                    <input type="hidden" asp-for="Input.ExistingBeforePath" id="inputExistingBefore" />
                    <input type="hidden" asp-for="Input.ExistingAfterPath" id="inputExistingAfter" />

                    <div class="row g-3">
                        <!-- Основная информация -->
                        <div class="col-md-12">
                            <label asp-for="Input.Title" class="form-label">Заголовок кейса</label>
                            <input asp-for="Input.Title" class="form-control bg-dark text-white" id="inputTitle" required />
                        </div>

                        <div class="col-md-6">
                            <label asp-for="Input.DeviceModel" class="form-label">Модель устройства</label>
                            <input asp-for="Input.DeviceModel" class="form-control bg-dark text-white" id="inputDevice" placeholder="iPhone 13" />
                        </div>
                        <div class="col-md-6">
                            <label asp-for="Input.ServiceType" class="form-label">Тип услуги</label>
                            <input asp-for="Input.ServiceType" class="form-control bg-dark text-white" id="inputService" placeholder="Замена стекла" />
                        </div>

                        <div class="col-md-6">
                            <label asp-for="Input.Cost" class="form-label">Цена выполненной работы</label>
                            <input asp-for="Input.Cost" type="number" class="form-control bg-dark text-white" id="inputCost" />
                        </div>
                        <div class="col-md-6">
                            <label asp-for="Input.DateCompleted" class="form-label">Дата выполнения</label>
                            <input asp-for="Input.DateCompleted" type="datetime-local" class="form-control bg-dark text-white" id="inputDate" />
                        </div>

                        <div class="col-12">
                            <label asp-for="Input.Description" class="form-label">Описание проблемы и решения</label>
                            <textarea asp-for="Input.Description" class="form-control bg-dark text-white" id="inputDesc" rows="4"></textarea>
                        </div>

                        <hr class="border-secondary my-4" />
                        <h6 class="text-info">Фотоотчет</h6>

                        <!-- Загрузка фото -->
                        <div class="col-md-6">
                            <label class="form-label">Фото ДО</label>
                            <input asp-for="Input.UploadBefore" type="file" class="form-control bg-dark text-white" accept="image/*" />
                            <div id="previewBefore" class="mt-2 text-muted small"></div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Фото ПОСЛЕ</label>
                            <input asp-for="Input.UploadAfter" type="file" class="form-control bg-dark text-white" accept="image/*" />
                            <div id="previewAfter" class="mt-2 text-muted small"></div>
                        </div>

                        <hr class="border-secondary my-4" />
                        <h6 class="text-warning">SEO настройки</h6>

                        <div class="col-12">
                            <label asp-for="Input.Slug" class="form-label">URL (Slug)</label>
                            <input asp-for="Input.Slug" class="form-control bg-dark text-white" id="inputSlug" placeholder="Оставьте пустым для автогенерации" />
                        </div>
                        <div class="col-md-6">
                            <label asp-for="Input.MetaTitle" class="form-label">Meta Title</label>
                            <input asp-for="Input.MetaTitle" class="form-control bg-dark text-white" id="inputMetaTitle" />
                        </div>
                        <div class="col-md-6">
                            <label asp-for="Input.MetaDescription" class="form-label">Meta Description</label>
                            <input asp-for="Input.MetaDescription" class="form-control bg-dark text-white" id="inputMetaDesc" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-success">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function openModal(data) {
            var modal = new bootstrap.Modal(document.getElementById('caseModal'));

            if (data) {
                // Edit Mode
                document.getElementById('modalTitle').innerText = 'Редактировать кейс';
                document.getElementById('inputId').value = data.id;
                document.getElementById('inputTitle').value = data.title;
                document.getElementById('inputDesc').value = data.description || '';
                document.getElementById('inputDevice').value = data.deviceModel || '';
                document.getElementById('inputService').value = data.serviceType || '';
                document.getElementById('inputCost').value = data.cost;
                document.getElementById('inputDate').value = data.dateCompleted;

                document.getElementById('inputSlug').value = data.slug || '';
                document.getElementById('inputMetaTitle').value = data.metaTitle || '';
                document.getElementById('inputMetaDesc').value = data.metaDescription || '';

                // Images logic
                document.getElementById('inputExistingBefore').value = data.imgBefore || '';
                document.getElementById('inputExistingAfter').value = data.imgAfter || '';

                document.getElementById('previewBefore').innerHTML = data.imgBefore
                    ? `Текущее: <a href="${data.imgBefore}" target="_blank" class="text-info">Открыть</a>`
                    : 'Нет фото';
                document.getElementById('previewAfter').innerHTML = data.imgAfter
                    ? `Текущее: <a href="${data.imgAfter}" target="_blank" class="text-info">Открыть</a>`
                    : 'Нет фото';

            } else {
                // Create Mode
                document.getElementById('modalTitle').innerText = 'Новый кейс';
                document.querySelector('form').reset();
                document.getElementById('inputId').value = '';
                document.getElementById('previewBefore').innerHTML = '';
                document.getElementById('previewAfter').innerHTML = '';

                // Set Default Date to Now
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('inputDate').value = now.toISOString().slice(0, 16);
            }

            modal.show();
        }
    </script>
}